---
layout: "post"
title: "在 512MB 微型 VPS 上创建虚拟内存并安装 Codex"
date: "2025-12-10 00:00"
categories: ["tutorial"]
tags: ["vps","vibe coding"]
published: True
---

在 512MB 甚至 256MB 这种微型 VPS 上跑现代工具（比如 `bun add`、`npm install`、Codex CLI）时，很容易遭遇内核 OOM（Out of Memory）直接把进程干掉：

<!--more-->

```
/usr/bin/env: ‘node’: No such file or directory
Out of memory: Killed process ...
```

此类问题一般由两点引起：

1. **系统没有 Node.js**
2. **没有启用 swap，内存耗尽即被 OOM 干掉**

以下内容提供清晰可靠的处理流程：
（1）释放磁盘空间 →（2）创建并启用 1GB swap →（3）安装 Node.js 20（NodeSource）→（4）安装 Codex CLI
最后附带完整一键脚本。

---

## 1. 查看当前内存与 swap 状态

```bash
free -h
swapon --show
```

典型输出（Swap 为 0B）：

```
Swap: 0B  0B  0B
```

必须先启用 swap 才能稳定运行安装工具。

---

## 2. 释放磁盘空间（若 / 已满）

检查磁盘：

```bash
df -h
```

若使用率100%，需要先清理：

```bash
sudo truncate -s 0 /var/log/sing-box/access.log 2>/dev/null || true
sudo truncate -s 0 /var/log/btmp.1               2>/dev/null || true
sudo apt-get clean
```

再次确认：

```bash
df -h
```

---

## 3. 创建并启用 1GB swapfile

### 删除旧 swapfile（如果有）

```bash
sudo swapoff /swapfile 2>/dev/null || true
sudo rm -f /swapfile 2>/dev/null || true
```

### 创建新 swapfile

```bash
sudo fallocate -l 1G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

### 检查 swap 是否生效

```bash
swapon --show
free -h
```

应看到类似：

```
Swap:
/swapfile   file   1G   0B   1G
```

---

## 4. 开机自动挂载 swap

```bash
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

---

## 5. 安装 Node.js 20（NodeSource 官方源）

Codex CLI 基于 Node.js，因此必须先安装 Node.js。
使用 NodeSource 可获得最新稳定版本。

```bash
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs
```

确认版本：

```bash
node -v
```

---

## 6. 安装 Codex CLI

```bash
sudo npm install -g @openai/codex
```

确认安装成功：

```bash
which codex
codex --help
```

若能正常输出帮助信息，则安装完成。

---

# 一键脚本：创建 swap + 安装 Node.js20 + 安装 Codex

保存为 `setup_codex.sh`：

```bash
#!/usr/bin/env bash
set -e

SWAP_SIZE="1G"

echo ">>> 清理日志与 APT 缓存"
sudo truncate -s 0 /var/log/sing-box/access.log 2>/dev/null || true
sudo truncate -s 0 /var/log/btmp.1               2>/dev/null || true
sudo apt-get clean || true

echo ">>> 删除旧 swapfile（如有）"
sudo swapoff /swapfile 2>/dev/null || true
sudo rm -f /swapfile 2>/dev/null || true

echo ">>> 创建新的 swapfile (${SWAP_SIZE})"
sudo fallocate -l "${SWAP_SIZE}" /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

echo ">>> 写入 /etc/fstab（如果缺失）"
FSTAB_LINE="/swapfile none swap sw 0 0"
if ! grep -q "^/swapfile " /etc/fstab 2>/dev/null; then
  echo "${FSTAB_LINE}" | sudo tee -a /etc/fstab >/dev/null
fi

echo ">>> 安装 Node.js 20（NodeSource）"
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

echo ">>> Node 版本："
node -v

echo ">>> 安装 Codex CLI"
sudo npm install -g @openai/codex

echo ">>> Codex CLI 已安装"
which codex || true
codex --help || true

echo ">>> 完成"
free -h
swapon --show
```

运行：

```bash
chmod +x setup_codex.sh
./setup_codex.sh
```

微型 VPS 上运行 Codex CLI 至此即可稳定运行，不再遇到 OOM Killed 或 node 不存在的问题。

---

如需我为你的服务器环境进一步优化配置，也可继续发我 `df -h`、`free -h`、`top` 等输出。

